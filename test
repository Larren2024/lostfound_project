<?php
session_start();
include("includes/db.php");

$message = "";

if ($_SERVER["REQUEST_METHOD"] == "POST") {
    $email = mysqli_real_escape_string($conn, $_POST['email']);
    $password = mysqli_real_escape_string($conn, $_POST['password']);

    // Check if user exists
    $sql = "SELECT * FROM users WHERE email='$email' LIMIT 1";
    $result = mysqli_query($conn, $sql);

    if ($result && mysqli_num_rows($result) == 1) {
        $user = mysqli_fetch_assoc($result);

        // Verify password (assuming plain text for simplicity)
        if ($user['password'] === $password) {
            // âœ… Set session
            $_SESSION['user_id'] = $user['id'];
            $_SESSION['username'] = $user['username']; // optional
            header("Location: index.php");
            exit();
        } else {
            $message = "Incorrect password.";
        }
    } else {
        $message = "User not found.";
    }
}
?>

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Lost & Found System</title>

    <!-- Vendor CSS -->
    <link rel="stylesheet" href="assets/vendors/mdi/css/materialdesignicons.min.css">
    <link rel="stylesheet" href="assets/vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="assets/vendors/css/vendor.bundle.base.css">
    <link rel="stylesheet" href="assets/vendors/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="shortcut icon" href="assets/images/favicon.png" />
    
    <style>
      body {
        background: #f4f7fc;
      }
      .page-title {
        font-size: 2rem;
        font-weight: bold;
        color: #333;
      }
      .card {
        border-radius: 12px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      }
      .btn-lg {
        border-radius: 8px;
      }
      table img {
        border-radius: 6px;
      }
    </style>
  </head>

  <body>
    <div class="container py-5">
      <!-- Page Title -->
       <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="page-title">ðŸ“¦ Lost & Found System</h1>
      <a href="logout.php" class="btn btn-outline-danger">
    <i class="mdi mdi-logout"></i> Logout
      </a>
    </div>

      <!-- Navigation Buttons -->
      <div class="d-flex justify-content-center gap-3 mb-4">
        <a href="report_lost.php" class="btn btn-danger btn-lg">
          <i class="mdi mdi-alert-circle"></i> Report Lost Item
        </a>
        <a href="report_found.php" class="btn btn-success btn-lg">
          <i class="mdi mdi-check-circle"></i> Report Found Item
        </a>
      </div>

     


      <!-- Search Section -->
      <div class="card p-4 mb-5">
        <h3 class="mb-3"><i class="mdi mdi-magnify"></i> Search Lost & Found Items</h3>
        <form method="GET" action="index.php" class="row g-3">
          <div class="col-md-4">
            <input type="text" name="search" class="form-control" placeholder="Search by item name...">
          </div>
          <div class="col-md-4">
            <select name="category" class="form-select">
              <option value="">All Categories</option>
              <option value="phone">Phone</option>
              <option value="wallet">Wallet</option>
              <option value="keys">Keys</option>
              <option value="documents">Documents</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" class="btn btn-primary w-100">
              <i class="mdi mdi-magnify"></i> Search
            </button>
          </div>
        </form>
      </div>

      <!-- Results Section -->
      <div class="card p-4">
        <h3 class="mb-3"><i class="mdi mdi-format-list-bulleted"></i> Reported Items</h3>
        <div class="table-responsive">
          <table class="table table-bordered table-striped">
            <thead class="table-dark">
              <tr>
                <th>ID</th>
                <th>Type</th>
                <th>Name</th>
                <th>Category</th>
                <th>Location</th>
                <th>Status</th>
                <th>Photo</th>
              </tr>
            </thead>
            <tbody>
              <?php
              include("includes/db.php");

              $where = "";
              if (!empty($_GET['search'])) {
                $search = mysqli_real_escape_string($conn, $_GET['search']);
                $where .= " AND item_name LIKE '%$search%'";
              }
              if (!empty($_GET['category'])) {
                $cat = mysqli_real_escape_string($conn, $_GET['category']);
                $where .= " AND category='$cat'";
              }

              $sql = "(SELECT id, 'Lost' as type, item_name, category, last_seen_location as location, status, photo_path, created_at 
                      FROM lost_items)
                      UNION
                      (SELECT id, 'Found' as type, item_name, category, found_location as location, status, photo_path, created_at 
                      FROM found_items)
                      WHERE 1=1 $where
                      ORDER BY created_at DESC
                      LIMIT 20";

              $result = mysqli_query($conn, $sql);

              if ($result && mysqli_num_rows($result) > 0) {
                while($row = mysqli_fetch_assoc($result)) {
                  echo "<tr>
                          <td>{$row['id']}</td>
                          <td><span class='badge ".($row['type']=='Lost'?'bg-danger':'bg-success')."'>{$row['type']}</span></td>
                          <td>{$row['item_name']}</td>
                          <td>{$row['category']}</td>
                          <td>{$row['location']}</td>
                          <td><span class='badge bg-info'>{$row['status']}</span></td>
                          <td>";
                  if ($row['photo_path']) {
                    echo "<img src='{$row['photo_path']}' width='60'>";
                  } else {
                    echo "-";
                  }
                  echo "</td>
                        </tr>";
                }
              } else {
                echo "<tr><td colspan='7' class='text-center'>No items found.</td></tr>";
              }

              mysqli_close($conn);
              ?>
            </tbody>
          </table>
        </div>
      </div>
    </div>
 


    <?php include('includes/footer.php'); ?>
    <!-- Vendor JS -->
    <script src="assets/vendors/js/vendor.bundle.base.js"></script>
    <script src="assets/vendors/chart.js/chart.umd.js"></script>
    <script src="assets/vendors/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
    <script src="assets/js/off-canvas.js"></script>
    <script src="assets/js/misc.js"></script>
    <script src="assets/js/settings.js"></script>
    <script src="assets/js/todolist.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script src="assets/js/dashboard.js"></script>
  </body>
</html>
